## key 在 diff 中的作用

我们知道，**Vue diff 算法的目的是对比虚拟 DOM 找出更新前与更新后的差异，通过只更新差异点来尽可能地减少对真实 DOM 的操作，从而提高性能。**

在这个过程中复用节点是一个重要话题，如何找到能够复用的节点是 diff 算法中的一个重要的步骤，找到的能复用的节点越多也就代表着我们能尽可能少地去操作真实 DOM。

然而有时候我们并不能很好地识别哪些元素可以被复用，一个最经典的例子：

更新前

```html
<div class='1'>1</div>
<div class='2'>2</div>
<div class='3'>3</div>
```

更新后

```html
<div class='1'>1</div>
<div class='3'>3</div>
<div class='2'>2</div>
```

上面例子中，更新前、更新后的节点仅仅只是改变了顺序，其他都没有变化，最好的结果应该是直接通过移动 DOM 来更新。而实际在对比时，我们却发现不了这一点。我们只能将新、旧的三个元素逐个对比，然后更新其内容。

如果我们让开发人员给列表中每个元素添加一个 key 标识，那么上面例子如下：

更新前

```html
<div key='1' class='1'>1</div>
<div key='2' class='2'>2</div>
<div key='3' class='3'>3</div>
```

更新后

```html
<div key='1' class='1'>1</div>
<div key='3' class='3'>3</div>
<div key='2' class='2'>2</div>
```

这样一来，在 diff 时，我们就可以通过 key 来尝试在老的节点中找到可复用 DOM，从而实现 DOM 复用。

## FAQ

### Q：⭐key 有什么作用？

1、key 是 Vue 提供给开发者的一个节点属性，它主要作用于 Vue 中的 diff 算法过程。在 Vue diff 过程中，Vue 会尽量复用之前的旧节点来达到最少操作真实 DOM 的目的，如果提供了正确的 key，那么 Vue 就可以在 diff 时通过 key 来从旧的节点中找到相同的的可复用节点（ ⭐注意：前提是相同节点的 key 在渲染前后不变 ），从而更好地来操作 DOM。

2、除此之外，由于节点前后 key 不同的话会被认为是不相同的节点，所以不会复用，而是会销毁旧的然后重新创建新的，所以在有些时候我们可能通过改变 key 来让 Vue重新渲染这个节点或者组件，这在有些情况下可能会有用。

### Q：不提供 key 会有什么问题？

假如我们在一个 for 循环中没有给子元素提供 key，那么 Vue 在进行 diff 更新的时候，可能会多做一些操作。

举个例子：

有一个渲染列表为 `[1,2,3]`, 更新后为` [1,3,2]`。假设都是使用 div 元素进行渲染在 Vue 2 进行双端 diff 算法时，由于没有提供 key，渲染前后所有元素的 key 都是 undefined，这也视为相同。那么在对比两个列表的尾部时，div-3 与 div-2 可以被认为是 相同的元素, Vue 会进行复用, 但由于文本节点的内容不同, 所以 Vue 需要使用 setTextContent 来改变 DOM 元素的内容,其他情况也类似。

但是如果提供了 key，那么 Vue 在 diff 的过程中通过 key 来寻找可复用节点，由于列表中的元素只是顺序变化了，所以 Vue 只需要移动 DOM 元素的位置即可而不需要对 DOM 进行更改操作。

这里只是举一个比较简单的例子，在一些复杂情况下，这种差异可能会尤为明显，所以在 for 循环中我们一般需要给每个子节点指定一个合理的 key。

### Q：没有 key 就不能复用元素吗？

不是的，没有 key 的，情况下，Vue 也会尝试从旧的子节点中查找能够复用的元素，虽然可能要做一些 patch 操作。如果提供了 key，Vue 在复用元素时就会更加精准，一定程度上可以进一步减少不必要的 DOM 操作。

## 总结

Vue DIff 中的 key 是为了标识列表中的元素，这个 key 值在**渲染前后不能变化**，且在**同级是唯一**。这样 Vue 就可以根据 key 值在老的节点中寻找是否由可复用节点，从而尽可能地多复用真实 DOM，减少真实 DOM 操作，提升应用性能。