
## 为什么

TCP 在连接关闭时需要进行 "四次挥手" 来确保双方的通信完全结束并且所有数据都被正确接收。这是因为 TCP 是一个全双工协议，意味着数据可以同时在两个方向上独立传输。每个方向的数据传输都需要单独终止，这就是需要四次挥手的原因。

## 四次挥手的过程

**1、第一次挥手（ FIN-1 ）：客户端发送 FIN 报文：**

- 当客户端决定结束连接时，客户端发送一个 FIN 报文，表示客户端已经没有数据要发送了
- 此时，客户端进入 **FIN-WAIT-1** 等待关闭连接状态

**2、第二次挥手（ ACK-1 ）：服务端回应 ACK 报文：**

- 服务端收到 FIN 报文后，确认客户端已经没有数据要发送了，服务端响应一个 ACK 报文，告诉客户端：我知道你没有数据要发送了
- 客户端收到 ACK 报文之后进入 **FIN-WAIT-2** 状态

**3、第三次挥手（ FIN-2 ）：服务端发送 FIN 报文：**

- 客户端没有要发送的数据了，但服务端可能还有数据要发给客户端，当服务端数据发送完毕后，服务端也会发送一个 FIN 报文给客户端，表示：我也没有数据要发送了
- 服务器进入 **LAST-ACK** 状态，等待客户端最后确认，这里服务端能直接关闭的原因是这个报文可能丢失，所以服务器要等待客户端的确认报文

**4、第四次挥手（ ACK-2 ）：客户端确认 ACK 报文**

- 客户端收到服务端的 FIN 报文后，响应一个 ACK 确认报文，表示：我收到了你的 FIN 报文
- 此时客户端进入 TIME-WAIT 阶段，经过一段时间（ 通常为 2MSL，即报文最大生存时间的 2 倍 ）后彻底关闭连接，释放资源。<mark style="background: #BBFABBA6;">这样等待的原因是防止一些因为延迟的网络包无法正确到达客户端</mark>。
- 服务器在收到 ACK 报文后立即进入 **CLOSE** 状态，释放资源

## 为什么不能三次挥手？

如果仅三次挥手，那么服务端没有等待客户端的 ACK 确认报文就直接关闭的话，服务端发送的 FIN 报文可能丢失而没有到达客户端，这样以来客户端就会一直等待造成资源的浪费

## 总结

TCP 需要四次挥手的主要原因是 TCP 是一个全双工通信，双方可以同时互发数据，四次挥手的目的时**为了保证双方都已经发送完数据并且对方都已经收到，这样才可以正确断开连接**


