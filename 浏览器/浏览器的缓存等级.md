
## ç¼“å­˜ç­‰çº§åˆ†ç±»

æµè§ˆå™¨çš„ç¼“å­˜å¤§æ¦‚å¯åˆ†ä¸ºä¸‹é¢å‡ ç§ï¼š

- Service Worker
- Memory Cache ï¼ˆ å†…å­˜ç¼“å­˜ ï¼‰
- Disk Cache ï¼ˆ ç£ç›˜ç¼“å­˜ ï¼‰

é‚£ä¹ˆæµè§ˆå™¨è¯»å–ç¼“å­˜çš„é¡ºåºæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

1ã€Service Worker
2ã€Memory Cache æˆ–è€… DiskCache
3ã€æœåŠ¡å™¨æ¨é€ Push Cacheï¼ˆ è¿™é‡Œä¸åšè¯¦ç»†è®¨è®º ï¼‰

## éªŒè¯

ä¸ºäº†éªŒè¯ä¸Šé¢è§‚ç‚¹ï¼Œæˆ‘ä»¬åšä¸€ä¸‹è¯•éªŒï¼š

å‡†å¤‡ä¸‹é¢ç›®å½•ç»“æ„ï¼š

![[image-20240827145434200.png]]

`index.html` æ–‡ä»¶ï¼š

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script>
    const registerServiceWorker = async () => {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('./sw.js', {
            scope: '/'
          })

          if (registration.installing) {
            console.log('æ­£åœ¨å®‰è£…');
          } else if (registration.waiting) {
            console.log('å·²å®‰è£…');
          } else if (registration.active) {
            console.log('æ¿€æ´»');
          }
        } catch (error) {
          console.log('æ³¨å†Œå¤±è´¥');
        }
      }
    }
    registerServiceWorker()
  </script>
</body>

</html>
```

`sw.js` æ–‡ä»¶ï¼š

```js
const addResourcesToCache = async (resources) => {
  // å¼€å¯ä¸€ä¸ªç¼“å­˜
  const cache = await self.caches.open('v1')
  await cache.addAll(resources)
}

self.addEventListener('install', (event) => {
  // ä½¿ç”¨ waitUntil ä¿è¯äº† ServiceWorker ä¸ä¼šåœ¨ waitUntil é‡Œé¢çš„ä»£ç æ‰§è¡Œå®Œæ¯•ä¹‹å‰å®‰è£…å®Œæˆ
  event.waitUntil(
    addResourcesToCache([
      "/",
      "/index.html",
    ])
  )
})


// å°†æŒ‡å®šè¯·æ±‚ã€å“åº”æ”¾åˆ° ServiceWorker ç¼“å­˜
const putInCache = async (request, response) => {
  if(request.url.indexOf('http')===0){
    const cache = await caches.open('v1')
    await cache.put(request, response)
  }
}


const cacheFirst = async ({ request, preloadResponsePromise, fallbackUrl }) => {
  console.log("ğŸš€ ~ cacheFirst ~ request:", request)
  const responseFromCache = await caches.match(request)
  if (responseFromCache) {
    // å¦‚æœ ServiceWorker æœ‰ç¼“å­˜ï¼Œå…ˆå–ç¼“å­˜
    return responseFromCache
  }

  // æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨ç¼“å­˜æˆ–è€…é¢„åŠ è½½çš„å“åº”
  // const preloadResponse = await preloadResponsePromise
  // if (preloadResponse) {
  //   putInCache(request, preloadResponse.clone())
  //   return preloadResponse
  // }

  try {
    // æ²¡æœ‰åŒ¹é…åˆ°ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œå›é€€åˆ°ç½‘ç»œè¯·æ±‚
    const responseFromNetwork = await fetch(request)
    // å“åº”å¯èƒ½è¢«ä½¿ç”¨
    // æˆ‘ä»¬éœ€è¦å°†å®ƒçš„æ‹·è´æ”¾åˆ°ç¼“å­˜
    // ç„¶åè¿”å›è¯¥å“åº”
    putInCache(request, responseFromNetwork.clone())
    return responseFromNetwork
  } catch (error) {
    const fallbackResponse = await caches.match(fallbackUrl)
    if (fallbackResponse) {
      return fallbackResponse
    }

    return new Response('Network error happened', {
      status: 408,
      headers: {
        "Content-Type": "text/plain"
      }
    })
  }
}

// è‡ªå®šä¹‰è¯·æ±‚å“åº”
self.addEventListener('fetch', (event) => {
  // event.respondWith(caches.match(event.request)) // å“åº”ç¼“å­˜ä¸­çš„ URL ä¸è¯·æ±‚ URL ç›¸åŒ¹é…çš„èµ„æº
  event.respondWith(cacheFirst({
    request: event.request,
    // preloadResponsePromise: event.preloadResponse,
    fallbackUrl: '/fallback.jpg'
  }))
})

const deleteCache = async (key) => {
  await self.caches.delete(key)
}

const deleteOldCaches = async () => {
  const cacheKeepList = ['v2']
  const keyList = await caches.keys()
  const cachesToDelete = keyList.filter(key => !cacheKeepList.includes('key'))
  await Promise.all(cachesToDelete.map(deleteCache))
}

self.addEventListener('activate', (event) => {
  event.waitUntil(self.registration?.navigationPreload.enable())
})
```

åœ¨ `sw.js` æ–‡ä»¶ä¸­ç¼“å­˜äº† `/`ã€`/index.html` è¿™ä¸¤ä¸ª URL ä¸‹çš„èµ„æºã€‚

ä¸‹é¢ä»¥ `serviceWorker` è¿™ä¸ªç›®å½•ä½œä¸ºæ ¹ç›®å½•å¯åŠ¨ä¸€ä¸ª http æœåŠ¡ï¼š

![[image-20240827145740841.png]]

å¯ä»¥çœ‹åˆ°ï¼Œèµ„æºæ˜¯ä½¿ç”¨ `Cache:3600 seconds` ç›¸å½“äº `Cache-Control:max-age=3600` è®¾ç½®äº†å¼ºç¼“å­˜ã€‚

ä¸‹é¢åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `http://localhost:8080/index.html`

![[image-20240827150001199.png]]

å¯ä»¥çœ‹åˆ° `index.html` åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶èµ°äº†ç½‘ç»œè¯·æ±‚

ä½¿ç”¨ `F5` åˆ·æ–°é¡µé¢

![[image-20240827150104976.png]]

å¯ä»¥çœ‹åˆ° `index.html` æ–‡ä»¶æ˜¯ä» ServiceWorker ä¸­è·å–çš„ã€‚

ç»è¿‡æµ‹è¯•ï¼Œè®¾ç½®äº†åå•†ç¼“ä¹‹åä¹Ÿæ˜¯å…ˆä» ServiceWorker ä¸­è¯»å–ã€‚

<mark style="background: #BBFABBA6;">ä¹Ÿå°±æ˜¯è¯´ ServiceWorker çš„ä¼˜å…ˆçº§è¦å¤§äºå¼ºç¼“å­˜ã€åå•†ç¼“å­˜</mark>

> æ³¨æ„ï¼šåœ¨è®¾å¤‡ç¦»çº¿çš„æ—¶å€™ï¼ŒServiceWorker ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°å‘æŒ¥ä½œç”¨ã€‚


## æ€»ç»“

åœ¨æ¿€æ´»äº† ServiceWorker ä¹‹åï¼ŒServiceWorker çš„ç¼“å­˜ä¼˜å…ˆçº§å¤§äºå…¶ä»–çš„ç¼“å­˜ä¼˜å…ˆçº§ã€‚